<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmTrails - AgriTourism & Farmer Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Load environment configuration from Netlify variables -->
    <script src="env-config.js"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #FF9800;
            --light: #F1F8E9;
            --dark: #1B5E20;
            --text: #212121;
            --accent: #8BC34A;
            --white: #ffffff;
            --gray-light: #f5f5f5;
            --gray: #757575;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--gray-light);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            padding-bottom: 70px;
        }
        
        /* Header Styles */
        header {
            background: linear-gradient(to right, var(--primary), var(--accent));
            color: var(--white);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 1.8rem;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .desktop-nav {
            display: none;
        }
        
        .desktop-nav-item {
            color: var(--white);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
        }
        
        .desktop-nav-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .cart-icon {
            position: relative;
            cursor: pointer;
        }
        
        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--secondary);
            color: var(--white);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--white);
            color: var(--white);
        }
        
        .btn-outline:hover {
            background: var(--white);
            color: var(--primary);
        }
        
        .btn-primary {
            background: var(--secondary);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background: #F57C00;
        }
        
        .btn-secondary {
            background: var(--primary);
            color: var(--white);
        }
        
        .btn-secondary:hover {
            background: #45a049;
        }
        
        /* Mobile Menu */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* Hero Section */
        .hero {
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), 
                        url('https://images.unsplash.com/photo-1500937386664-56d1dfef3854?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&h=500&q=80') no-repeat center center/cover;
            color: var(--white);
            padding: 3rem 1rem;
            text-align: center;
        }
        
        .hero-content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .hero h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }
        
        .hero p {
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .search-bar {
            display: flex;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .search-bar input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius) 0 0 var(--radius);
            font-size: 1rem;
        }
        
        .search-bar button {
            padding: 12px 20px;
            background: var(--secondary);
            color: var(--white);
            border: none;
            border-radius: 0 var(--radius) var(--radius) 0;
            cursor: pointer;
        }
        
        /* Section Styles */
        .section {
            padding: 2rem 1rem;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--dark);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .tours, .products {
            background: var(--light);
        }
        
        /* Content Toggle Buttons */
        .content-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .toggle-btn {
            padding: 10px 24px;
            background: var(--white);
            border: 2px solid var(--primary);
            border-radius: var(--radius);
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            min-width: 140px;
        }
        
        .toggle-btn.active {
            background: var(--primary);
            color: var(--white);
        }
        
        .toggle-btn:hover:not(.active) {
            background: var(--light);
        }
        
        /* Categories Section */
        .categories-section {
            background: var(--white);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        
        .categories-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .close-categories {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }
        
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .category-card {
            background: var(--light);
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .category-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }
        
        .category-card.active {
            border-color: var(--primary);
            background: var(--primary);
            color: var(--white);
        }
        
        .category-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .category-card.active .category-icon {
            color: var(--white);
        }
        
        .category-name {
            font-weight: 600;
            font-size: 1rem;
        }
        
        /* Card Styles */
        .card-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .card {
            background: var(--white);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
            cursor: pointer;
        }
        
        .card:hover {
            transform: translateY(-3px);
        }
        
        .card-img {
            height: 140px;
            overflow: hidden;
            position: relative;
        }
        
        .card-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .card-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--secondary);
            color: var(--white);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .card-content {
            padding: 1rem;
        }
        
        .card h3 {
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-size: 1rem;
        }
        
        .card p {
            color: var(--gray);
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .card-price {
            font-weight: bold;
            color: var(--secondary);
            font-size: 1rem;
            margin-bottom: 0.8rem;
        }
        
        .card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 0.8rem;
        }
        
        .card-actions {
            display: flex;
            gap: 8px;
        }
        
        .card-actions .btn {
            flex: 1;
            text-align: center;
            padding: 6px 10px;
            font-size: 0.8rem;
        }
        
        /* Out of Stock Styles */
        .out-of-stock {
            position: relative;
        }
        
        .out-of-stock::after {
            content: "Out of Stock";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .stock-low {
            color: #e74c3c;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        /* Delivery Warning */
        .delivery-warning {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 10px 15px;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .delivery-warning i {
            font-size: 1.2rem;
        }
        
        /* Location Selector */
        .location-selector {
            background: var(--white);
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
        }
        
        .location-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
        }
        
        .location-input {
            display: flex;
            gap: 10px;
        }
        
        .location-input input, .location-input select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 0.9rem;
        }
        
        .location-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 var(--radius) var(--radius);
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .location-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .location-suggestion:hover {
            background: var(--light);
        }
        
        .location-input-container {
            position: relative;
            flex: 1;
        }
        
        .location-loading {
            text-align: center;
            padding: 2rem;
        }
        
        /* Current Location Display */
        .current-location {
            background: var(--light);
            padding: 10px 15px;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .location-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Features Section */
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 1.5rem;
        }
        
        .feature-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .feature-card:hover {
            transform: translateY(-3px);
        }
        
        .feature-card i {
            font-size: 2.2rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .feature-card h3 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray);
            font-size: 0.7rem;
            transition: color 0.3s;
            flex: 1;
            position: relative;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        
        /* All Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 400px;
            height: 100%;
            background: var(--white);
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.open {
            display: block;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            background: var(--primary);
            color: var(--white);
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-content {
            padding: 1rem;
        }
        
        /* Cart Modal */
        .cart-item {
            display: flex;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--radius);
        }
        
        .cart-item-details {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .cart-item-price {
            color: var(--secondary);
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }
        
        .quantity-btn {
            background: #eee;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .remove-item {
            color: #f44336;
            background: none;
            border: none;
            cursor: pointer;
            margin-left: auto;
        }
        
        .cart-total {
            padding: 1rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }
        
        .checkout-btn {
            display: block;
            width: calc(100% - 2rem);
            margin: 0 1rem 1rem;
            padding: 12px;
            background: var(--secondary);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
        }
        
        .empty-state {
            padding: 2rem;
            text-align: center;
            color: var(--gray);
        }
        
        /* Orders Modal */
        .order-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .order-id {
            font-weight: bold;
            color: var(--dark);
        }
        
        .order-date {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .order-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-delivered {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-pending {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .order-details {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .order-product-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--radius);
        }
        
        .order-product-info {
            flex: 1;
        }
        
        .order-product-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .order-product-price {
            color: var(--secondary);
            font-weight: bold;
        }
        
        .order-total {
            text-align: right;
            font-weight: bold;
            color: var(--dark);
        }
        
        /* Profile Modal */
        .profile-info {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: var(--white);
            font-size: 2rem;
        }
        
        .profile-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .profile-email {
            color: var(--gray);
            margin-bottom: 1rem;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 2rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: var(--light);
            border-radius: var(--radius);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .profile-action-btn {
            padding: 12px;
            border: 1px solid #eee;
            border-radius: var(--radius);
            background: var(--white);
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .profile-action-btn:hover {
            background: var(--light);
        }
        
        .profile-action-btn i {
            width: 20px;
            color: var(--primary);
        }
        
        /* Invoice Modal */
        .invoice {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-width: 500px;
            margin: 0 auto;
        }
        
        .invoice-header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 1rem;
        }
        
        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .invoice-items {
            margin-bottom: 2rem;
        }
        
        .invoice-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .invoice-total {
            border-top: 2px solid var(--primary);
            padding-top: 1rem;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .invoice-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        
        /* Overlay */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .overlay.open {
            display: block;
        }
        
        /* Footer */
        footer {
            background: var(--dark);
            color: var(--white);
            padding: 2rem 1rem;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .footer-section h3 {
            margin-bottom: 1rem;
        }
        
        .footer-section ul {
            list-style: none;
        }
        
        .footer-section ul li {
            margin-bottom: 0.5rem;
        }
        
        .footer-section a {
            color: #ddd;
            text-decoration: none;
        }
        
        .social-icons {
            display: flex;
            gap: 15px;
            margin-top: 1rem;
        }
        
        .social-icons a {
            color: var(--white);
            font-size: 1.5rem;
        }
        
        .copyright {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            flex-direction: column;
            gap: 1rem;
            grid-column: 1 / -1;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* No Results Message */
        .no-results {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
            grid-column: 1 / -1;
        }
        
        .no-results i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ddd;
        }
        
        /* Search Suggestions Styles */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 0 0 var(--radius) var(--radius);
            box-shadow: var(--shadow);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .search-suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-suggestion-item:hover {
            background: var(--light);
        }
        
        .search-suggestion-item i {
            color: var(--primary);
            width: 20px;
        }
        
        .search-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .search-loading {
            position: absolute;
            right: 70px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .search-results-info {
            background: var(--light);
            padding: 10px 15px;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--dark);
        }
        
        /* Responsive Design */
        @media (min-width: 768px) {
            body {
                padding-bottom: 0;
            }
            
            .bottom-nav {
                display: none;
            }
            
            .desktop-nav {
                display: flex;
                align-items: center;
                gap: 15px;
            }
            
            .mobile-menu-btn {
                display: none;
            }
            
            .card-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
            }
            
            .categories-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
            }
            
            .card-img {
                height: 180px;
            }
            
            .hero {
                padding: 4rem 1rem;
            }
            
            .hero h2 {
                font-size: 2.2rem;
            }
            
            .section {
                padding: 3rem 1rem;
            }
            
            .section-title {
                font-size: 2rem;
            }
            
            .toggle-btn {
                min-width: 160px;
                padding: 12px 30px;
            }
        }
        
        @media (min-width: 1024px) {
            .card-container {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .categories-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="logo">
                <img src='https://ribehublefecccabzwkv.supabase.co/storage/v1/object/sign/assets/ximfy%20(1).png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xNzY4NzkxOC1hNjdkLTQ3MTItYjlmZi1jYzBiNTBkM2JmOTciLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhc3NldHMveGltZnkgKDEpLnBuZyIsImlhdCI6MTc2Nzg1NTEzNSwiZXhwIjozMTU1MzY3ODU1MTM1fQ.d53c3b9ER-846cAb4nhOcLp5nqhFITCmh4tNmCz5r24' alt='FarmTrails' style='height: 30px;'>
            </div>
            
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="header-right" id="headerRight">
                <!-- Desktop Navigation -->
                <nav class="desktop-nav">
                    <a href="#" class="desktop-nav-item active" id="navHome">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                    <a href="#" class="desktop-nav-item" id="navCategories">
                        <i class="fas fa-th-large"></i>
                        <span>Categories</span>
                    </a>
                    <a href="#" class="desktop-nav-item" id="navOrders">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Orders</span>
                    </a>
                    <a href="#" class="desktop-nav-item" id="navProfile">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                    <div class="cart-icon" id="cartIcon">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count" id="cartCount">0</span>
                    </div>
                </nav>
                
                <div class="profile">
                    <button class="btn btn-outline" id="logoutBtn">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Cart Modal -->
    <div class="modal" id="cartModal">
        <div class="modal-header">
            <h3>Your Cart</h3>
            <button class="close-modal" id="closeCart">&times;</button>
        </div>
        <div class="modal-content">
            <div class="cart-items" id="cartItems">
                <div class="empty-state" id="emptyCart">
                    <i class="fas fa-shopping-cart fa-2x"></i>
                    <p>Your cart is empty</p>
                </div>
            </div>
            <div class="cart-total" id="cartTotal" style="display: none;">
                <span>Total:</span>
                <span id="totalAmount">â‚¹0</span>
            </div>
            <button class="checkout-btn" id="checkoutBtn" style="display: none;" onclick="AppController.proceedToCheckout()">Proceed to Checkout</button>
        </div>
    </div>

    <!-- Orders Modal -->
    <div class="modal" id="ordersModal">
        <div class="modal-header">
            <h3>Your Orders</h3>
            <button class="close-modal" id="closeOrders">&times;</button>
        </div>
        <div class="modal-content">
            <div class="orders-list" id="ordersList">
                <div class="empty-state" id="noOrders">
                    <i class="fas fa-clipboard-list fa-2x"></i>
                    <p>You haven't placed any orders yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-header">
            <h3>My Profile</h3>
            <button class="close-modal" id="closeProfile">&times;</button>
        </div>
        <div class="modal-content">
            <div class="profile-info">
                <div class="profile-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-name" id="userName">Loading...</div>
                <div class="profile-email" id="userEmail">Loading...</div>
                <div class="profile-location" id="userLocation">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Loading...</span>
                </div>
            </div>
            
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-value" id="ordersCount">0</div>
                    <div class="stat-label">Orders</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cartItemsCount">0</div>
                    <div class="stat-label">Cart Items</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="joinedDate">2023</div>
                    <div class="stat-label">Member Since</div>
                </div>
            </div>
            
            <div class="profile-actions">
                <button class="profile-action-btn" onclick="AppController.editProfile()">
                    <i class="fas fa-edit"></i>
                    <span>Edit Profile</span>
                </button>
                <button class="profile-action-btn" onclick="AppController.viewAddresses()">
                    <i class="fas fa-address-book"></i>
                    <span>My Addresses</span>
                </button>
                <button class="profile-action-btn" onclick="AppController.changePassword()">
                    <i class="fas fa-lock"></i>
                    <span>Change Password</span>
                </button>
                <button class="profile-action-btn" onclick="AppController.contactSupport()">
                    <i class="fas fa-headset"></i>
                    <span>Contact Support</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal" id="invoiceModal">
        <div class="modal-header">
            <h3>Order Invoice</h3>
            <button class="close-modal" id="closeInvoice">&times;</button>
        </div>
        <div class="modal-content">
            <div class="invoice" id="invoiceContent">
                <!-- Invoice content will be generated here -->
            </div>
        </div>
    </div>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h2>Experience Authentic Rural Life</h2>
            <p>Book farm tours directly with local farmers and buy fresh produce straight from the source</p>
            
            <div class="search-container">
                <div class="search-bar">
                    <input type="text" id="globalSearch" placeholder="Search for farms, products or experiences...">
                    <button onclick="AppController.performSearch()"><i class="fas fa-search"></i> Search</button>
                </div>
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
        </div>
    </section>
    
    <!-- Current Location Display -->
    <section class="section" id="currentLocationSection" style="display: none;">
        <div class="container">
            <div class="current-location">
                <div class="location-info">
                    <i class="fas fa-map-marker-alt" style="color: var(--primary);"></i>
                    <div>
                        <strong>Current Location:</strong>
                        <span id="currentLocationText">Loading...</span>
                    </div>
                </div>
                <button class="btn btn-outline" onclick="AppController.changeLocation()" style="border-color: var(--primary); color: var(--primary);">
                    <i class="fas fa-edit"></i> Change
                </button>
            </div>
            <div id="detectedLocationDetails" style="margin-top:6px;font-size:1em;color:#444;"></div>
        </div>
    </section>
    
    <!-- Location Selector -->
    <section class="section" id="locationSection" style="display: none;">
        <div class="container">
            <div class="location-selector">
                <div class="location-header">
                    <i class="fas fa-map-marker-alt"></i>
                    <h3>Set Your Location</h3>
                </div>
                <p style="margin-bottom: 1rem; color: var(--gray);">We'll automatically detect your location to check delivery availability</p>
                
                <div class="location-loading" id="locationLoading" style="text-align: center; padding: 2rem;">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;">Detecting your location...</p>
                </div>

                <div class="location-input" id="manualLocationInput" style="display: none;">
                    <div class="location-input-container">
                        <input type="text" id="locationInput" placeholder="Or enter your area, city manually...">
                        <div class="location-suggestions" id="locationSuggestions"></div>
                    </div>
                    <button class="btn btn-primary" onclick="AppController.checkManualLocation()">Check Availability</button>
                </div>
                
                <div style="margin-top: 1rem; display: flex; gap: 10px; display: none;" id="locationActionButtons">
                    <button class="btn btn-outline" onclick="AppController.retryLocation()" style="flex: 1;">
                        <i class="fas fa-sync-alt"></i> Retry Detection
                    </button>
                    <button class="btn btn-outline" onclick="AppController.cancelLocation()" style="flex: 1;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Categories Section -->
    <section class="section" id="categoriesSection" style="display: none;">
        <div class="container">
            <div class="categories-section">
                <div class="categories-header">
                    <h2 class="section-title">Browse Categories</h2>
                    <button class="close-categories" id="closeCategories">&times;</button>
                </div>
                <div class="categories-grid" id="categoriesGrid">
                    <!-- Categories will be loaded here -->
                </div>
            </div>
        </div>
    </section>
    
    <!-- Main Content Section -->
    <section class="section">
        <div class="container">
            <!-- Content Toggle Section -->
            <div class="content-toggle">
                <button class="toggle-btn active" id="productsToggle">Fresh Products</button>
                <button class="toggle-btn" id="toursToggle">Farm Tours</button>
            </div>
            
            <!-- Delivery Warning -->
            <div id="deliveryWarning" class="delivery-warning" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>Delivery Not Available</strong>
                    <p>We currently deliver only within Hyderabad and surrounding areas. Please check your location.</p>
                </div>
            </div>
            
            <!-- Search Results Info -->
            <div id="searchResultsInfo" class="search-results-info" style="display: none;">
                <i class="fas fa-search"></i>
                <span id="searchResultsText">Showing results for "<span id="searchTermDisplay"></span>"</span>
                <button class="btn btn-outline" style="margin-left: 10px; padding: 5px 10px; font-size: 0.8rem;" onclick="AppController.clearSearch()">
                    Clear Search
                </button>
            </div>
            
            <!-- Products Section -->
            <div id="productsSection">
                <h2 class="section-title" id="productsTitle">Fresh From The Farm</h2>
                <div class="card-container" id="productsContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading products...</p>
                    </div>
                </div>
            </div>
            
            <!-- Tours Section -->
            <div id="toursSection" style="display: none;">
                <h2 class="section-title">Popular Farm Tours</h2>
                <div class="card-container" id="toursContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading tours...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Features Section -->
    <section class="section">
        <div class="container">
            <h2 class="section-title">How It Works</h2>
            <div class="features">
                <div class="feature-card">
                    <i class="fas fa-search-location"></i>
                    <h3>Discover Farms</h3>
                    <p>Explore authentic farming experiences near you or at your travel destination</p>
                </div>
                
                <div class="feature-card">
                    <i class="fas fa-calendar-check"></i>
                    <h3>Book Tours</h3>
                    <p>Reserve your spot for farm visits, workshops, and agricultural experiences</p>
                </div>
                
                <div class="feature-card">
                    <i class="fas fa-shopping-basket"></i>
                    <h3>Buy Fresh Produce</h3>
                    <p>Purchase farm-fresh products directly from farmers without middlemen</p>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>FarmTrails</h3>
                    <p>Connecting tourists with local farmers for authentic agricultural experiences and fresh farm products.</p>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#">Home</a></li>
                        <li><a href="#">Farm Tours</a></li>
                        <li><a href="#">Farm Products</a></li>
                        <li><a href="#">Become a Host</a></li>
                        <li><a href="#">About Us</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <ul>
                        <li><i class="fas fa-map-marker-alt"></i> 123 Farm Road, Agricultural District</li>
                        <li><i class="fas fa-phone"></i> +91 6309841404</li>
                        <li><i class="fas fa-envelope"></i> gchandavath@gmail.com</li>
                    </ul>
                </div>
            </div>
            
            <div class="copyright">
                <p>&copy; 2025 FarmTrails. All rights reserved.</p>
            </div>
        </div>
    </footer>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" id="bottomHome">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item" id="bottomCategories">
            <i class="fas fa-th-large"></i>
            <span>Categories</span>
        </a>
        <a href="#" class="nav-item" id="bottomOrders">
            <i class="fas fa-clipboard-list"></i>
            <span>Orders</span>
        </a>
        <a href="#" class="nav-item" id="bottomProfile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
        <a href="#" class="nav-item" id="bottomCartBtn">
            <i class="fas fa-shopping-cart"></i>
            <span>Cart</span>
            <span class="cart-count" id="bottomCartCount">0</span>
        </a>
    </nav>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://ribehublefecccabzwkv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpYmVodWJsZWZlY2NjYWJ6d2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMzg1ODksImV4cCI6MjA3NjkxNDU4OX0.4i6yQOCAisuFnElBKzCf_kdfl1SV5t6OknEVmPfySYc';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        

        // Hyderabad ORR (Outer Ring Road) geofence logic
        const HYDERABAD_CENTER = { lat: 17.385044, lng: 78.486671 };
        const ORR_POLYGON_COORDS = [
            [17.198497, 78.390372],
            [17.208230, 78.439333],
            [17.208414, 78.550771],
            [17.276809, 78.656423],
            [17.338635, 78.659286],
            [17.392153, 78.686791],
            [17.477744, 78.705016],
            [17.562024, 78.620846],
            [17.573154, 78.572809],
            [17.600461, 78.447827],
            [17.554635, 78.380576],
            [17.539855, 78.230554],
            [17.418365, 78.270638],
            [17.381684, 78.347533],
            [17.194121, 78.377669],
            [17.198497, 78.390372]
        ];

        // Calculate distance between two coordinates in meters
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Point-in-polygon geofence check
        function isWithinGeofence(lat, lng) {
            let inside = false;
            for (let i = 0, j = ORR_POLYGON_COORDS.length - 1; i < ORR_POLYGON_COORDS.length; j = i++) {
                const xi = ORR_POLYGON_COORDS[i][0], yi = ORR_POLYGON_COORDS[i][1];
                const xj = ORR_POLYGON_COORDS[j][0], yj = ORR_POLYGON_COORDS[j][1];
                const intersect = ((yi > lng) !== (yj > lng)) && (lat < (xj - xi) * (lng - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        // Location suggestions data
        const LOCATION_SUGGESTIONS = [
            'Hyderabad', 'Secunderabad', 'Cyberabad', 'Madhapur', 'Gachibowli', 
            'Hitech City', 'Banjara Hills', 'Jubilee Hills', 'Kukatpally', 'Ameerpet',
            'Abids', 'Koti', 'Nampally', 'Begumpet', 'Somajiguda', 'Rangareddy',
            'Medchal', 'Sangareddy', 'Vikarabad'
        ];

        // Categories Data
        const CATEGORIES = [
            { id: 'vegetables', name: 'Vegetables', icon: 'fas fa-carrot', description: 'Fresh seasonal vegetables', color: '#4CAF50' },
            { id: 'fruits', name: 'Fruits', icon: 'fas fa-apple-alt', description: 'Organic fresh fruits', color: '#FF9800' },
            { id: 'spices', name: 'Spices & Masalas', icon: 'fas fa-mortar-pestle', description: 'Authentic Indian spices', color: '#795548' },
            { id: 'dairy', name: 'Dairy Products', icon: 'fas fa-cheese', description: 'Fresh milk and dairy', color: '#2196F3' },
            { id: 'grains', name: 'Grains & Pulses', icon: 'fas fa-wheat-awn', description: 'Organic grains and pulses', color: '#8BC34A' },
            { id: 'honey', name: 'Honey & Sweets', icon: 'fas fa-honey-pot', description: 'Pure honey and sweets', color: '#FFC107' },
            { id: 'eggs', name: 'Eggs & Poultry', icon: 'fas fa-egg', description: 'Farm fresh eggs', color: '#FF5722' },
            { id: 'beverages', name: 'Beverages', icon: 'fas fa-wine-bottle', description: 'Fresh juices and drinks', color: '#9C27B0' }
        ];

        // Resolve current user id from URL, session, or storage
        function getResolvedUserId() {
            const params = new URLSearchParams(window.location.search);
            const queryId = params.get('user_id') || params.get('userId') || params.get('id');
            if (queryId) return queryId;

            const storedDirect = localStorage.getItem('userId') || localStorage.getItem('currentUserId') || sessionStorage.getItem('currentUserId');
            if (storedDirect) return storedDirect;

            const storedUser = sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser') || localStorage.getItem('user');
            if (storedUser) {
                try {
                    const parsed = JSON.parse(storedUser);
                    if (parsed && (parsed.id || parsed.userId || parsed.consumer_id)) {
                        return parsed.id || parsed.userId || parsed.consumer_id;
                    }
                } catch (err) {
                    console.warn('Failed to parse stored user payload:', err);
                }
            }

            return null;
        }

        const RESOLVED_USER_ID = getResolvedUserId();

        // Global State Management
        const AppState = {
            cartItems: JSON.parse(localStorage.getItem('cartItems')) || [],
            allProducts: [],
            allTours: [],
            currentSearchState: { isSearching: false, searchTerm: '', searchResults: { products: [], tours: [] } },
            currentContent: 'products',
            currentCategory: null,
            userLocation: {
                location: localStorage.getItem('userLocation') || null,
                pincode: localStorage.getItem('userPincode') || null,
                deliveryAvailable: localStorage.getItem('deliveryAvailable') === 'true' || false
            },
            currentUserId: RESOLVED_USER_ID || 'user123',
            categoriesVisible: false,
            userProfile: null,
            searchTimeout: null,
            isSearching: false,
            locationTimeout: null,
            locationDetectionAttempted: false
        };

        // DOM Elements
        const elements = {
            overlay: document.getElementById('overlay'),
            cartModal: document.getElementById('cartModal'),
            ordersModal: document.getElementById('ordersModal'),
            profileModal: document.getElementById('profileModal'),
            invoiceModal: document.getElementById('invoiceModal'),
            navHome: document.getElementById('navHome'),
            navCategories: document.getElementById('navCategories'),
            navOrders: document.getElementById('navOrders'),
            navProfile: document.getElementById('navProfile'),
            cartIcon: document.getElementById('cartIcon'),
            bottomHome: document.getElementById('bottomHome'),
            bottomCategories: document.getElementById('bottomCategories'),
            bottomOrders: document.getElementById('bottomOrders'),
            bottomProfile: document.getElementById('bottomProfile'),
            bottomCartBtn: document.getElementById('bottomCartBtn'),
            categoriesSection: document.getElementById('categoriesSection'),
            locationSection: document.getElementById('locationSection'),
            currentLocationSection: document.getElementById('currentLocationSection'),
            productsSection: document.getElementById('productsSection'),
            toursSection: document.getElementById('toursSection'),
            productsToggle: document.getElementById('productsToggle'),
            toursToggle: document.getElementById('toursToggle'),
            closeCart: document.getElementById('closeCart'),
            closeOrders: document.getElementById('closeOrders'),
            closeProfile: document.getElementById('closeProfile'),
            closeCategories: document.getElementById('closeCategories'),
            closeInvoice: document.getElementById('closeInvoice'),
            productsContainer: document.getElementById('productsContainer'),
            toursContainer: document.getElementById('toursContainer'),
            categoriesGrid: document.getElementById('categoriesGrid'),
            cartItems: document.getElementById('cartItems'),
            ordersList: document.getElementById('ordersList'),
            invoiceContent: document.getElementById('invoiceContent'),
            cartCount: document.getElementById('cartCount'),
            bottomCartCount: document.getElementById('bottomCartCount'),
            emptyCart: document.getElementById('emptyCart'),
            noOrders: document.getElementById('noOrders'),
            cartTotal: document.getElementById('cartTotal'),
            totalAmount: document.getElementById('totalAmount'),
            checkoutBtn: document.getElementById('checkoutBtn'),
            deliveryWarning: document.getElementById('deliveryWarning'),
            productsTitle: document.getElementById('productsTitle'),
            globalSearch: document.getElementById('globalSearch'),
            locationInput: document.getElementById('locationInput'),
            logoutBtn: document.getElementById('logoutBtn'),
            userName: document.getElementById('userName'),
            userEmail: document.getElementById('userEmail'),
            userLocation: document.getElementById('userLocation'),
            ordersCount: document.getElementById('ordersCount'),
            cartItemsCount: document.getElementById('cartItemsCount'),
            joinedDate: document.getElementById('joinedDate'),
            searchSuggestions: document.getElementById('searchSuggestions'),
            searchResultsInfo: document.getElementById('searchResultsInfo'),
            searchTermDisplay: document.getElementById('searchTermDisplay'),
            locationSuggestions: document.getElementById('locationSuggestions'),
            currentLocationText: document.getElementById('currentLocationText'),
            locationLoading: document.getElementById('locationLoading'),
            manualLocationInput: document.getElementById('manualLocationInput'),
            locationActionButtons: document.getElementById('locationActionButtons')
        };

        // API Service Class
        class CustomerAPIService {
            static getApiBaseUrl() {
                const params = new URLSearchParams(window.location.search);
                const queryApi = params.get('apiUrl') || params.get('api') || params.get('backend');
                if (queryApi) return queryApi;

                if (window.CONFIG?.API_URL) return window.CONFIG.API_URL;
                if (window.CONFIG?.API_BASE_URL) return window.CONFIG.API_BASE_URL;

                const storedApi = localStorage.getItem('API_URL') || localStorage.getItem('apiUrl') || localStorage.getItem('backendUrl');
                if (storedApi) return storedApi;

                if (window.location.origin && window.location.origin !== 'file://') {
                    return window.location.origin;
                }

                return 'http://localhost:5000';
            }

            static async getProducts(category = null, search = null, limit = 20) {
                try {
                    // Build query parameters
                    const params = new URLSearchParams();
                    if (category && category !== 'all') params.append('category', category);
                    if (search && search.length >= 2) params.append('search', search);
                    params.append('limit', limit);

                    const API_BASE_URL = this.getApiBaseUrl();
                    const response = await fetch(`${API_BASE_URL}/api/public/products?${params}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    // The backend returns { success, count, products }
                    return result.success ? (result.products || []) : [];

                } catch (error) {
                    console.error('Error fetching products from API:', error);
                    return this.getSampleProducts();
                }
            }

            static async getTours(search = null, limit = 10) {
                try {
                    // Build query parameters
                    const params = new URLSearchParams();
                    if (search && search.length >= 2) params.append('search', search);
                    params.append('limit', limit);

                    const API_BASE_URL = this.getApiBaseUrl();
                    const response = await fetch(`${API_BASE_URL}/api/tours?${params}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    return result.success ? result.data : [];

                } catch (error) {
                    console.error('Error fetching tours from API:', error);
                    return this.getSampleTours();
                }
            }

            static async searchAll(searchTerm) {
                try {
                    // Search products
                    const productsQuery = supabase
                        .from('products')
                        .select('*')
                        .eq('is_active', true)
                        .or(`name.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%,category.ilike.%${searchTerm}%`)
                        .limit(5);

                    // Search tours
                    const toursQuery = supabase
                        .from('tours')
                        .select('*')
                        .eq('is_active', true)
                        .or(`name.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%`)
                        .limit(5);

                    const [productsResult, toursResult] = await Promise.all([
                        productsQuery,
                        toursQuery
                    ]);

                    return {
                        products: productsResult.data || [],
                        tours: toursResult.data || []
                    };

                } catch (error) {
                    console.error('Error searching:', error);
                    return { products: [], tours: [] };
                }
            }

            static async getOrders(userId) {
                try {
                    const { data, error } = await supabase
                        .from('orders')
                        .select('*')
                        .eq('user_id', userId)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    return data || [];

                } catch (error) {
                    console.error('Error fetching orders:', error);
                    return this.getSampleOrders();
                }
            }

            static async checkDelivery(location, pincode = null) {
                try {
                    let isAvailable = false;
                    let detectedPincode = pincode;
                    
                    // Check if location is in service areas
                    for (const [area, pincodes] of Object.entries(SERVICE_AREAS)) {
                        if (location.toLowerCase().includes(area.toLowerCase())) {
                            isAvailable = true;
                            if (!detectedPincode && pincodes.length > 0) {
                                detectedPincode = pincodes[0] + 'XXX'; // Placeholder pincode
                            }
                            break;
                        }
                    }
                    
                    // If no area match, check if it's a pincode
                    if (!isAvailable && location.match(/^\d{6}$/)) {
                        const pincodePrefix = location.substring(0, 3);
                        for (const pincodes of Object.values(SERVICE_AREAS)) {
                            if (pincodes.includes(pincodePrefix)) {
                                isAvailable = true;
                                detectedPincode = location;
                                break;
                            }
                        }
                    }

                    await supabase.from('delivery_checks').insert({
                        location: location,
                        pincode: detectedPincode,
                        is_available: isAvailable,
                        checked_at: new Date().toISOString()
                    });

                    return { isAvailable, pincode: detectedPincode };

                } catch (error) {
                    console.error('Error checking delivery:', error);
                    return { isAvailable: false, pincode: null };
                }
            }

            static async reverseGeocode(latitude, longitude) {
                try {
                    // Using OpenStreetMap Nominatim API for reverse geocoding
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`
                    );
                    
                    if (!response.ok) {
                        throw new Error('Reverse geocoding failed');
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.address) {
                        const address = data.address;
                        
                        // Try to get the most specific location name
                        let locationName = '';
                        
                        if (address.city) {
                            locationName = address.city;
                        } else if (address.town) {
                            locationName = address.town;
                        } else if (address.village) {
                            locationName = address.village;
                        } else if (address.suburb) {
                            locationName = address.suburb;
                        } else if (address.county) {
                            locationName = address.county;
                        } else if (address.state) {
                            locationName = address.state;
                        }
                        
                        // Add state for context if available
                        if (address.state && locationName !== address.state) {
                            locationName += `, ${address.state}`;
                        }
                        
                        return locationName || 'Unknown Location';
                    }
                    
                    return 'Unknown Location';
                    
                } catch (error) {
                    console.error('Reverse geocoding error:', error);
                    return null;
                }
            }

            static async getLocationFromBrowser() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation is not supported by this browser'));
                        return;
                    }
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 10000, // 10 seconds
                        maximumAge: 600000 // 10 minutes
                    };
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const { latitude, longitude } = position.coords;
                            try {
                                // Get location name from coordinates
                                const locationName = await CustomerAPIService.reverseGeocode(latitude, longitude);
                                resolve({
                                    latitude,
                                    longitude,
                                    locationName,
                                    success: true
                                });
                            } catch (error) {
                                resolve({
                                    latitude,
                                    longitude,
                                    locationName: null,
                                    success: false
                                });
                            }
                        },
                        (error) => {
                            reject(error);
                        },
                        options
                    );
                });
            }

            static async logUserActivity(userId, activityType, details = {}) {
                try {
                    await supabase.from('user_activities').insert({
                        user_id: userId,
                        activity_type: activityType,
                        details: details,
                        created_at: new Date().toISOString()
                    });
                } catch (error) {
                    console.error('Error logging activity:', error);
                }
            }

            static async logoutUser(userId) {
                try {
                    await this.logUserActivity(userId, 'logout', {
                        logout_time: new Date().toISOString()
                    });

                    localStorage.removeItem('userLocation');
                    localStorage.removeItem('userPincode');
                    localStorage.removeItem('deliveryAvailable');
                    localStorage.removeItem('cartItems');
                    
                    return true;
                } catch (error) {
                    console.error('Error during logout:', error);
                    return false;
                }
            }

            static async getUserProfile(userId) {
                try {
                    if (!userId) return null;

                    // Primary: backend API backed by consumers table
                    const apiBase = this.getApiBaseUrl();
                    try {
                        const response = await fetch(`${apiBase}/api/consumer/profile/${encodeURIComponent(userId)}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success && result.profile) {
                                return result.profile;
                            }
                        } else {
                            console.error('Consumer profile API failed:', response.status, response.statusText);
                        }
                    } catch (apiError) {
                        console.error('Error fetching consumer profile from API:', apiError);
                    }

                    // Fallback: direct Supabase query to consumers table
                    const { data, error } = await supabase
                        .from('consumers')
                        .select('*')
                        .eq('id', userId)
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Error fetching consumer profile:', error);
                    return null;
                }
            }

            static async createOrder(orderData) {
                try {
                    const { data, error } = await supabase
                        .from('orders')
                        .insert([orderData])
                        .select()
                        .single();

                    if (error) throw error;
                    return data;

                } catch (error) {
                    console.error('Error creating order:', error);
                    throw error;
                }
            }

            static async updateProductStock(productId, newStock) {
                try {
                    const { error } = await supabase
                        .from('products')
                        .update({ stock: newStock })
                        .eq('id', productId);

                    if (error) throw error;
                } catch (error) {
                    console.error('Error updating product stock:', error);
                    throw error;
                }
            }

            // Sample data fallbacks
            static getSampleProducts() {
                return [
                    {
                        id: '1', name: 'Organic Tomatoes', description: 'Fresh, pesticide-free tomatoes', price: 80, unit: 'kg',
                        images: ['https://images.unsplash.com/photo-1546470427-e212b7d310ff?ixlib=rb-4.0.3'], category: 'vegetables', stock: 45,
                        farmer: { name: 'Rajesh Kumar', farm: 'Green Valley Organic Farm' }, is_active: true
                    },
                    {
                        id: '2', name: 'Fresh Apples', description: 'Crisp and juicy apples', price: 120, unit: 'kg',
                        images: ['https://images.unsplash.com/photo-1568702846914-96b305d2aaeb?ixlib=rb-4.0.3'], category: 'fruits', stock: 32,
                        farmer: { name: 'Sunita Devi', farm: 'Sunny Orchards' }, is_active: true
                    },
                    {
                        id: '3', name: 'Organic Turmeric Powder', description: 'Freshly harvested turmeric', price: 350, unit: '500gm',
                        images: ['https://images.unsplash.com/photo-1615485500834-bc10199bc727'], category: 'spices', stock: 28,
                        farmer: { name: 'Vikram Singh', farm: 'Spice Garden' }, is_active: true
                    },
                    {
                        id: '4', name: 'Fresh Cow Milk', description: 'Pure farm fresh milk', price: 60, unit: 'liter',
                        images: ['https://images.unsplash.com/photo-1563636619-e9143da7973b?ixlib=rb-4.0.3'], category: 'dairy', stock: 20,
                        farmer: { name: 'Gopal Yadav', farm: 'Happy Cow Dairy' }, is_active: true
                    }
                ];
            }

            static getSampleTours() {
                return [
                    {
                        id: 'tour1', name: 'Organic Vegetable Farm Tour', description: 'Guided tour of organic farm', price: 499,
                        images: ['https://images.unsplash.com/photo-1520052203542-d3095f1b6cf0?ixlib=rb-4.0.3'], duration: '2 hours', capacity: '15 people',
                        farmer: { name: 'Rajesh Kumar', farm: 'Green Valley Organic Farm' }, is_active: true
                    }
                ];
            }

            static getSampleOrders() {
                return [
                    {
                        id: 'order1', order_id: 'FT-2023-001', created_at: '2023-10-15T10:30:00Z', status: 'delivered', total: 850,
                        items: [
                            { name: 'Organic Tomatoes', price: 80, quantity: 2, image: 'https://images.unsplash.com/photo-1546470427-e212b7d310ff?ixlib=rb-4.0.3' }
                        ]
                    }
                ];
            }
        }

        // Core Application Functions
        class AppController {
            static initialize() {
                this.setupEventListeners();
                this.initializeCategories();
                this.loadInitialData();
                this.checkUserLocation();
            }

            static setupEventListeners() {
                // Modal Controls
                elements.cartIcon.addEventListener('click', () => this.openModal('cart'));
                elements.bottomCartBtn.addEventListener('click', () => this.openModal('cart'));
                elements.closeCart.addEventListener('click', () => this.closeModal('cart'));
                
                elements.navOrders.addEventListener('click', (e) => { e.preventDefault(); this.openModal('orders'); });
                elements.bottomOrders.addEventListener('click', (e) => { e.preventDefault(); this.openModal('orders'); });
                elements.closeOrders.addEventListener('click', () => this.closeModal('orders'));
                
                // Profile navigation - open inline profile modal
                elements.navProfile.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await this.loadUserProfile();
                    this.openModal('profile');
                });
                elements.bottomProfile.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await this.loadUserProfile();
                    this.openModal('profile');
                });
                elements.closeProfile.addEventListener('click', () => this.closeModal('profile'));

                elements.closeInvoice.addEventListener('click', () => this.closeModal('invoice'));

                // Categories
                elements.navCategories.addEventListener('click', (e) => { e.preventDefault(); this.toggleCategories(); });
                elements.bottomCategories.addEventListener('click', (e) => { e.preventDefault(); this.toggleCategories(); });
                elements.closeCategories.addEventListener('click', () => this.hideCategories());

                // Content Toggles
                elements.productsToggle.addEventListener('click', () => this.setActiveContent('products'));
                elements.toursToggle.addEventListener('click', () => this.setActiveContent('tours'));

                // Navigation
                elements.navHome.addEventListener('click', (e) => { e.preventDefault(); this.showHome(); });
                elements.bottomHome.addEventListener('click', (e) => { e.preventDefault(); this.showHome(); });

                // Search
                elements.globalSearch.addEventListener('input', (e) => this.handleSearchInput(e));
                elements.globalSearch.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.performSearch();
                });

                // Location Input
                elements.locationInput.addEventListener('input', (e) => this.handleLocationInput(e));
                elements.locationInput.addEventListener('focus', () => this.showLocationSuggestions());
                
                // Overlay
                elements.overlay.addEventListener('click', () => this.closeAllModals());

                // Logout
                elements.logoutBtn.addEventListener('click', () => this.handleLogout());

                // Close suggestions when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-container')) {
                        elements.searchSuggestions.style.display = 'none';
                    }
                    if (!e.target.closest('.location-input-container')) {
                        elements.locationSuggestions.style.display = 'none';
                    }
                });
            }

            static async loadInitialData() {
                await this.loadProducts();
                await this.loadTours();
                await this.loadUserProfile();
                this.updateCartUI();
            }

            static async loadProducts(category = null) {
                try {
                    elements.productsContainer.innerHTML = this.getLoadingHTML('Loading products...');
                    
                    const products = await CustomerAPIService.getProducts(category);
                    AppState.allProducts = products;
                    
                    // Filter by category if specified
                    let filteredProducts = products;
                    if (category) {
                        filteredProducts = products.filter(product => product.category === category);
                    }
                    
                    this.displayProducts(filteredProducts);
                    
                    await CustomerAPIService.logUserActivity(AppState.currentUserId, 'load_products', {
                        category: category,
                        count: filteredProducts.length
                    });

                } catch (error) {
                    elements.productsContainer.innerHTML = this.getErrorHTML('Error Loading Products');
                }
            }

            static async loadTours() {
                try {
                    elements.toursContainer.innerHTML = this.getLoadingHTML('Loading tours...');
                    
                    const tours = await CustomerAPIService.getTours();
                    AppState.allTours = tours;
                    this.displayTours(tours);
                    
                    await CustomerAPIService.logUserActivity(AppState.currentUserId, 'load_tours', {
                        count: tours.length
                    });

                } catch (error) {
                    elements.toursContainer.innerHTML = this.getErrorHTML('Error Loading Tours');
                }
            }

            static async loadOrders() {
                try {
                    const orders = await CustomerAPIService.getOrders(AppState.currentUserId);
                    this.displayOrders(orders);
                    
                    await CustomerAPIService.logUserActivity(AppState.currentUserId, 'view_orders', {
                        count: orders.length
                    });

                } catch (error) {
                    elements.ordersList.innerHTML = this.getErrorHTML('Error Loading Orders', true);
                }
            }

            static async loadUserProfile() {
                try {
                    if (!AppState.currentUserId) {
                        this.displayProfile(this.getDefaultProfile());
                        return;
                    }

                    const profile = await CustomerAPIService.getUserProfile(AppState.currentUserId);
                    AppState.userProfile = profile;
                    this.displayProfile(profile);
                } catch (error) {
                    console.error('Error loading profile:', error);
                    this.displayProfile(this.getDefaultProfile());
                }
            }

            static getDefaultProfile() {
                return {
                    username: 'Customer',
                    full_name: 'Guest User',
                    email: 'guest@example.com',
                    mobile: '--',
                    status: 'active',
                    location: 'Not provided',
                    joined_date: new Date().getFullYear().toString(),
                    orders_count: 0,
                    profile_photo_url: ''
                };
            }

            static initializeCategories() {
                elements.categoriesGrid.innerHTML = CATEGORIES.map(category => `
                    <div class="category-card" data-category="${category.id}">
                        <div class="category-icon">
                            <i class="${category.icon}"></i>
                        </div>
                        <div class="category-name">${category.name}</div>
                        <div class="category-description" style="font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem;">
                            ${category.description}
                        </div>
                    </div>
                `).join('');

                document.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const category = this.getAttribute('data-category');
                        AppController.selectCategory(category);
                    });
                });
            }

            static selectCategory(categoryId) {
                AppState.currentCategory = categoryId;
                
                // Update UI
                document.querySelectorAll('.category-card').forEach(card => {
                    card.classList.remove('active');
                });
                document.querySelector(`.category-card[data-category="${categoryId}"]`).classList.add('active');
                
                // Load products for this category and hide categories section
                this.loadProducts(categoryId);
                this.hideCategories();
                
                // Update title
                const categoryName = CATEGORIES.find(cat => cat.id === categoryId)?.name || categoryId;
                elements.productsTitle.textContent = `${categoryName} - Fresh From The Farm`;
                
                CustomerAPIService.logUserActivity(AppState.currentUserId, 'select_category', {
                    category: categoryId
                });
            }

            static toggleCategories() {
                if (AppState.categoriesVisible) {
                    this.hideCategories();
                } else {
                    this.showCategories();
                }
            }

            static showCategories() {
                AppState.categoriesVisible = true;
                elements.categoriesSection.style.display = 'block';
                elements.categoriesSection.scrollIntoView({ behavior: 'smooth' });
                
                CustomerAPIService.logUserActivity(AppState.currentUserId, 'view_categories');
            }

            static hideCategories() {
                AppState.categoriesVisible = false;
                elements.categoriesSection.style.display = 'none';
            }

            static setActiveContent(content) {
                AppState.currentContent = content;
                
                elements.productsToggle.classList.toggle('active', content === 'products');
                elements.toursToggle.classList.toggle('active', content === 'tours');
                
                elements.productsSection.style.display = content === 'products' ? 'block' : 'none';
                elements.toursSection.style.display = content === 'tours' ? 'block' : 'none';
                
                this.hideCategories();
                
                CustomerAPIService.logUserActivity(AppState.currentUserId, `view_${content}`);
            }

            static showHome() {
                this.hideCategories();
                this.setActiveContent('products');
                elements.productsTitle.textContent = 'Fresh From The Farm';
                AppState.currentCategory = null;
                this.loadProducts();
                
                document.querySelectorAll('.category-card').forEach(card => {
                    card.classList.remove('active');
                });
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            static openModal(modalType) {
                elements.overlay.classList.add('open');
                
                switch(modalType) {
                    case 'cart':
                        elements.cartModal.classList.add('open');
                        break;
                    case 'orders':
                        elements.ordersModal.classList.add('open');
                        this.loadOrders();
                        break;
                    case 'profile':
                        elements.profileModal.classList.add('open');
                        break;
                    case 'invoice':
                        elements.invoiceModal.classList.add('open');
                        break;
                }
                
                document.body.style.overflow = 'hidden';
            }

            static closeModal(modalType) {
                elements.overlay.classList.remove('open');
                
                switch(modalType) {
                    case 'cart':
                        elements.cartModal.classList.remove('open');
                        break;
                    case 'orders':
                        elements.ordersModal.classList.remove('open');
                        break;
                    case 'profile':
                        elements.profileModal.classList.remove('open');
                        break;
                    case 'invoice':
                        elements.invoiceModal.classList.remove('open');
                        break;
                }
                
                document.body.style.overflow = 'auto';
            }

            static closeAllModals() {
                elements.overlay.classList.remove('open');
                elements.cartModal.classList.remove('open');
                elements.ordersModal.classList.remove('open');
                elements.profileModal.classList.remove('open');
                elements.invoiceModal.classList.remove('open');
                document.body.style.overflow = 'auto';
            }

            static checkUserLocation() {
                if (!AppState.userLocation.location) {
                    // Show location section and start automatic detection
                    this.showLocationSelector();
                    this.detectCurrentLocation();
                } else {
                    this.showCurrentLocation();
                    this.updateDeliveryWarning();
                }
            }

            static showLocationSelector() {
                elements.locationSection.style.display = 'block';
                elements.currentLocationSection.style.display = 'none';
                elements.locationLoading.style.display = 'block';
                elements.manualLocationInput.style.display = 'none';
                elements.locationActionButtons.style.display = 'none';
            }

            static async detectCurrentLocation() {
                try {
                    AppController.showNotification('Detecting your location...', 5000);
                    
                    const locationData = await CustomerAPIService.getLocationFromBrowser();
                    
                    if (locationData.success && locationData.locationName) {
                        // Successfully got location
                        await this.processDetectedLocation(locationData.locationName, locationData.latitude, locationData.longitude);
                    } else {
                        throw new Error('Could not determine location name');
                    }
                    
                } catch (error) {
                    console.error('Location detection failed:', error);
                    this.showManualLocationInput(error.message);
                }
            }

            static async processDetectedLocation(locationName, latitude = null, longitude = null) {
                this.showNotification(`Location detected: ${locationName}`);
                // Check delivery availability for detected location
                const { isAvailable, pincode } = await CustomerAPIService.checkDelivery(locationName, null, latitude, longitude);
                AppState.userLocation = {
                    location: locationName,
                    pincode: pincode,
                    deliveryAvailable: isAvailable
                };
                // Save to localStorage
                localStorage.setItem('userLocation', locationName);
                localStorage.setItem('userPincode', pincode);
                localStorage.setItem('deliveryAvailable', isAvailable);
                // Update UI
                this.showCurrentLocation();
                this.updateDeliveryWarning();
                this.updateDetectedLocationDetails(locationName, latitude, longitude);
                if (isAvailable) {
                    this.showNotification(`ðŸŽ‰ Delivery available in ${locationName}!`);
                } else {
                    this.showNotification(`âš ï¸ Delivery not available in ${locationName}. We serve Hyderabad and surrounding areas.`);
                }
                // Log activity
                await CustomerAPIService.logUserActivity(AppState.currentUserId, 'auto_location_detected', {
                    location: locationName,
                    is_available: isAvailable
                });
            }

            static updateDetectedLocationDetails(locationName, latitude = null, longitude = null) {
                let details = `<strong>Detected Location:</strong> ${locationName}`;
                if (latitude !== null && longitude !== null) {
                    details += `<br><span style='font-size:0.95em;color:#666'>Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}</span>`;
                }
                const el = document.getElementById('detectedLocationDetails');
                if (el) el.innerHTML = details;
            }

            static showManualLocationInput(errorMessage = null) {
                elements.locationLoading.style.display = 'none';
                elements.manualLocationInput.style.display = 'flex';
                elements.locationActionButtons.style.display = 'flex';
                
                if (errorMessage) {
                    this.showNotification(errorMessage, 5000);
                }
                
                // Focus on the input field
                setTimeout(() => {
                    elements.locationInput.focus();
                }, 100);
            }

            static async retryLocation() {
                elements.locationLoading.style.display = 'block';
                elements.manualLocationInput.style.display = 'none';
                elements.locationActionButtons.style.display = 'none';
                
                await this.detectCurrentLocation();
            }

            static async checkManualLocation() {
                const location = elements.locationInput.value.trim();
                if (!location) {
                    this.showNotification('Please enter your location');
                    return;
                }

                this.showNotification('Checking delivery availability...');

                const { isAvailable, pincode } = await CustomerAPIService.checkDelivery(location);
                AppState.userLocation = {
                    location: location,
                    pincode: pincode,
                    deliveryAvailable: isAvailable
                };

                localStorage.setItem('userLocation', location);
                localStorage.setItem('userPincode', pincode);
                localStorage.setItem('deliveryAvailable', isAvailable);

                this.updateDeliveryWarning();
                this.showCurrentLocation();

                if (isAvailable) {
                    this.showNotification(`ðŸŽ‰ Delivery available in ${location}!`);
                } else {
                    this.showNotification(`âš ï¸ Delivery not available in ${location}. We serve Hyderabad and surrounding areas.`);
                }

                await CustomerAPIService.logUserActivity(AppState.currentUserId, 'manual_location_entry', {
                    location: location,
                    is_available: isAvailable
                });
            }

            static showCurrentLocation() {
                elements.locationSection.style.display = 'none';
                elements.currentLocationSection.style.display = 'block';
                elements.currentLocationText.textContent = AppState.userLocation.location;
            }

            static changeLocation() {
                // Clear current location and show location selector
                AppState.userLocation.location = null;
                AppState.userLocation.deliveryAvailable = false;
                localStorage.removeItem('userLocation');
                localStorage.removeItem('userPincode');
                localStorage.removeItem('deliveryAvailable');
                
                this.showLocationSelector();
                this.detectCurrentLocation();
            }

            static cancelLocation() {
                if (AppState.userLocation.location) {
                    this.showCurrentLocation();
                } else {
                    // If no location is set, keep showing the location selector
                    // but don't force the user to set location immediately
                    elements.locationSection.style.display = 'none';
                    this.showNotification('You can set your location later from the profile section');
                }
            }

            static handleLocationInput(e) {
                const location = e.target.value.trim();
                
                // Clear previous timeout
                if (AppState.locationTimeout) {
                    clearTimeout(AppState.locationTimeout);
                }
                
                if (location.length < 2) {
                    elements.locationSuggestions.style.display = 'none';
                    return;
                }
                
                // Set timeout for suggestions (debounce)
                AppState.locationTimeout = setTimeout(() => {
                    this.showLocationSuggestions(location);
                }, 300);
            }

            static showLocationSuggestions(filter = '') {
                const filteredSuggestions = LOCATION_SUGGESTIONS.filter(location =>
                    location.toLowerCase().includes(filter.toLowerCase())
                );
                
                if (filteredSuggestions.length === 0) {
                    elements.locationSuggestions.style.display = 'none';
                    return;
                }
                
                elements.locationSuggestions.innerHTML = filteredSuggestions
                    .map(location => `
                        <div class="location-suggestion" onclick="AppController.selectLocationSuggestion('${location}')">
                            <i class="fas fa-map-marker-alt"></i> ${location}
                        </div>
                    `).join('');
                
                elements.locationSuggestions.style.display = 'block';
            }

            static selectLocationSuggestion(location) {
                elements.locationInput.value = location;
                elements.locationSuggestions.style.display = 'none';
            }

            static updateDeliveryWarning() {
                if (AppState.userLocation.deliveryAvailable) {
                    elements.deliveryWarning.style.display = 'none';
                } else {
                    elements.deliveryWarning.style.display = 'flex';
                }
            }

            static handleSearchInput(e) {
                const searchTerm = e.target.value.trim();
                
                // Clear previous timeout
                if (AppState.searchTimeout) {
                    clearTimeout(AppState.searchTimeout);
                }
                
                // Hide suggestions if search term is too short
                if (searchTerm.length < 2) {
                    elements.searchSuggestions.style.display = 'none';
                    return;
                }
                
                // Show loading state
                elements.searchSuggestions.innerHTML = `
                    <div class="search-suggestion-item">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Searching...</span>
                    </div>
                `;
                elements.searchSuggestions.style.display = 'block';
                
                // Set timeout for search (debounce)
                AppState.searchTimeout = setTimeout(async () => {
                    await this.showSearchSuggestions(searchTerm);
                }, 500);
            }

            static async showSearchSuggestions(searchTerm) {
                try {
                    const results = await CustomerAPIService.searchAll(searchTerm);
                    
                    if (results.products.length === 0 && results.tours.length === 0) {
                        elements.searchSuggestions.innerHTML = `
                            <div class="search-suggestion-item">
                                <i class="fas fa-search"></i>
                                <span>No results found for "${searchTerm}"</span>
                            </div>
                        `;
                        return;
                    }
                    
                    let suggestionsHTML = '';
                    
                    // Add product suggestions
                    results.products.slice(0, 3).forEach(product => {
                        suggestionsHTML += `
                            <div class="search-suggestion-item" onclick="AppController.selectSuggestion('${product.name}', 'product')">
                                <i class="fas fa-shopping-basket"></i>
                                <div>
                                    <div style="font-weight: 500;">${product.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--gray);">Product - â‚¹${product.price}/${product.unit}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    // Add tour suggestions
                    results.tours.slice(0, 2).forEach(tour => {
                        suggestionsHTML += `
                            <div class="search-suggestion-item" onclick="AppController.selectSuggestion('${tour.name}', 'tour')">
                                <i class="fas fa-tractor"></i>
                                <div>
                                    <div style="font-weight: 500;">${tour.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--gray);">Tour - â‚¹${tour.price}/person</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    // Add "View all results" option
                    suggestionsHTML += `
                        <div class="search-suggestion-item" onclick="AppController.performSearch()" style="border-top: 1px solid #eee; background: var(--light);">
                            <i class="fas fa-list"></i>
                            <span style="font-weight: 500;">View all results for "${searchTerm}"</span>
                        </div>
                    `;
                    
                    elements.searchSuggestions.innerHTML = suggestionsHTML;
                    
                } catch (error) {
                    console.error('Error fetching search suggestions:', error);
                    elements.searchSuggestions.innerHTML = `
                        <div class="search-suggestion-item">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Error loading suggestions</span>
                        </div>
                    `;
                }
            }

            static selectSuggestion(term, type) {
                elements.globalSearch.value = term;
                elements.searchSuggestions.style.display = 'none';
                
                if (type === 'tour') {
                    this.setActiveContent('tours');
                }
                
                this.performSearch();
            }

            static async performSearch() {
                const searchTerm = elements.globalSearch.value.trim();
                elements.searchSuggestions.style.display = 'none';
                
                if (!searchTerm) {
                    this.clearSearch();
                    return;
                }
                
                if (searchTerm.length < 2) {
                    this.showNotification('Please enter at least 2 characters to search');
                    return;
                }
                
                try {
                    AppState.isSearching = true;
                    
                    // Show search results info
                    elements.searchResultsInfo.style.display = 'block';
                    elements.searchTermDisplay.textContent = searchTerm;
                    
                    // Show loading states
                    elements.productsContainer.innerHTML = this.getLoadingHTML('Searching products...');
                    elements.toursContainer.innerHTML = this.getLoadingHTML('Searching tours...');
                    
                    // Search products and tours
                    const [searchedProducts, searchedTours] = await Promise.all([
                        CustomerAPIService.getProducts(null, searchTerm),
                        CustomerAPIService.getTours(searchTerm)
                    ]);
                    
                    AppState.currentSearchState = {
                        isSearching: true,
                        searchTerm: searchTerm,
                        searchResults: { products: searchedProducts, tours: searchedTours }
                    };
                    
                    // Update results count
                    const productCount = searchedProducts.length;
                    const tourCount = searchedTours.length;
                    const resultsText = `Found ${productCount} product${productCount !== 1 ? 's' : ''} and ${tourCount} tour${tourCount !== 1 ? 's' : ''}`;
                    document.getElementById('searchResultsText').innerHTML = `<i class="fas fa-search"></i> ${resultsText} for "<span id="searchTermDisplay">${searchTerm}</span>"`;
                    
                    this.displayProducts(searchedProducts);
                    this.displayTours(searchedTours);
                    
                    CustomerAPIService.logUserActivity(AppState.currentUserId, 'search', {
                        term: searchTerm,
                        product_results: searchedProducts.length,
                        tour_results: searchedTours.length
                    });
                    
                } catch (error) {
                    this.showNotification('Error performing search');
                    console.error('Search error:', error);
                } finally {
                    AppState.isSearching = false;
                }
            }

            static clearSearch() {
                elements.globalSearch.value = '';
                elements.searchResultsInfo.style.display = 'none';
                elements.searchSuggestions.style.display = 'none';
                
                AppState.currentSearchState.isSearching = false;
                
                // Reload original content
                if (AppState.currentContent === 'products') {
                    this.loadProducts(AppState.currentCategory);
                } else {
                    this.loadTours();
                }
                
                CustomerAPIService.logUserActivity(AppState.currentUserId, 'clear_search');
            }

            static addToCart(item) {
                const existingItemIndex = AppState.cartItems.findIndex(cartItem => 
                    cartItem.id === item.id && cartItem.type === item.type
                );
                
                if (existingItemIndex !== -1) {
                    AppState.cartItems[existingItemIndex].quantity += 1;
                } else {
                    AppState.cartItems.push({ ...item, quantity: 1 });
                }
                
                this.updateCartUI();
                this.saveCartToLocalStorage();
                this.showNotification(`${item.name} added to cart!`);
                
                CustomerAPIService.logUserActivity(AppState.currentUserId, 'add_to_cart', {
                    product_name: item.name,
                    product_id: item.id,
                    type: item.type
                });
                
                if (window.innerWidth > 768) {
                    this.openModal('cart');
                }
            }

            static updateCartUI() {
                const totalItems = AppState.cartItems.reduce((total, item) => total + item.quantity, 0);
                
                elements.cartCount.textContent = totalItems;
                elements.bottomCartCount.textContent = totalItems;
                elements.bottomCartCount.style.display = totalItems > 0 ? 'flex' : 'none';
                
                elements.cartItems.innerHTML = '';
                
                if (AppState.cartItems.length === 0) {
                    elements.emptyCart.style.display = 'block';
                    elements.cartTotal.style.display = 'none';
                    elements.checkoutBtn.style.display = 'none';
                } else {
                    elements.emptyCart.style.display = 'none';
                    
                    let total = 0;
                    AppState.cartItems.forEach((item, index) => {
                        const itemTotal = item.price * item.quantity;
                        total += itemTotal;
                        
                        const cartItemElement = document.createElement('div');
                        cartItemElement.className = 'cart-item';
                        cartItemElement.innerHTML = `
                            <img src="${item.image}" alt="${item.name}" class="cart-item-img">
                            <div class="cart-item-details">
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-price">â‚¹${item.price}</div>
                                <div class="cart-item-type" style="font-size: 0.8rem; color: var(--gray);">${item.type === 'tour' ? 'Tour' : 'Product'}</div>
                                <div class="cart-item-quantity">
                                    <button class="quantity-btn" onclick="AppController.changeQuantity(${index}, -1)">-</button>
                                    <span>${item.quantity}</span>
                                    <button class="quantity-btn" onclick="AppController.changeQuantity(${index}, 1)">+</button>
                                </div>
                            </div>
                            <button class="remove-item" onclick="AppController.removeItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                        elements.cartItems.appendChild(cartItemElement);
                    });
                    
                    elements.totalAmount.textContent = `â‚¹${total}`;
                    elements.cartTotal.style.display = 'flex';
                    elements.checkoutBtn.style.display = 'block';
                }
            }

            static changeQuantity(index, change) {
                AppState.cartItems[index].quantity += change;
                
                if (AppState.cartItems[index].quantity <= 0) {
                    AppState.cartItems.splice(index, 1);
                }
                
                this.updateCartUI();
                this.saveCartToLocalStorage();
            }

            static removeItem(index) {
                AppState.cartItems.splice(index, 1);
                this.updateCartUI();
                this.saveCartToLocalStorage();
            }

            static saveCartToLocalStorage() {
                localStorage.setItem('cartItems', JSON.stringify(AppState.cartItems));
            }

            static async proceedToCheckout() {
                if (AppState.cartItems.length === 0) {
                    this.showNotification('Your cart is empty');
                    return;
                }

                if (!AppState.userLocation.deliveryAvailable) {
                    this.showNotification('Delivery not available in your area');
                    return;
                }

                try {
                    // Process payment (simulated)
                    window.location.href = 'payment.html';
                    //this.showNotification('Processing payment...');
                    
                    // Create order in Supabase
                    const orderData = {
                        user_id: AppState.currentUserId,
                        order_id: `FT-${Date.now()}`,
                        items: AppState.cartItems,
                        total: AppState.cartItems.reduce((total, item) => total + (item.price * item.quantity), 0),
                        status: 'confirmed',
                        delivery_address: AppState.userLocation.location,
                        created_at: new Date().toISOString()
                    };

                    const order = await CustomerAPIService.createOrder(orderData);
                    
                    // Update product stocks
                    for (const item of AppState.cartItems) {
                        if (item.type === 'product') {
                            const product = AppState.allProducts.find(p => p.id === item.id);
                            if (product) {
                                const newStock = product.stock - item.quantity;
                                await CustomerAPIService.updateProductStock(item.id, newStock);
                            }
                        }
                    }

                    // Clear cart
                    AppState.cartItems = [];
                    this.updateCartUI();
                    this.saveCartToLocalStorage();
                    
                    // Show invoice
                    this.showInvoice(order);
                    
                    this.closeModal('cart');
                    
                    CustomerAPIService.logUserActivity(AppState.currentUserId, 'order_placed', {
                        order_id: order.order_id,
                        total: order.total
                    });

                } catch (error) {
                    this.showNotification('Error processing order. Please try again.');
                    console.error('Checkout error:', error);
                }
            }

            static showInvoice(order) {
                const invoiceHTML = `
                    <div class="invoice-header">
                        <h2>FarmTrails</h2>
                        <p>Order Invoice</p>
                    </div>
                    
                    <div class="invoice-details">
                        <div>
                            <strong>Order ID:</strong><br>
                            ${order.order_id}
                        </div>
                        <div>
                            <strong>Date:</strong><br>
                            ${new Date(order.created_at).toLocaleDateString()}
                        </div>
                        <div>
                            <strong>Customer:</strong><br>
                            ${AppState.userProfile?.full_name || 'Guest User'}
                        </div>
                        <div>
                            <strong>Delivery To:</strong><br>
                            ${order.delivery_address}
                        </div>
                    </div>
                    
                    <div class="invoice-items">
                        <h3>Order Items</h3>
                        ${order.items.map(item => `
                            <div class="invoice-item">
                                <span>${item.name} x${item.quantity}</span>
                                <span>â‚¹${item.price * item.quantity}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="invoice-total">
                        <div class="invoice-item">
                            <span>Total Amount:</span>
                            <span>â‚¹${order.total}</span>
                        </div>
                    </div>
                    
                    <div class="invoice-actions">
                        <button class="btn btn-primary" onclick="AppController.printInvoice()">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button class="btn btn-secondary" onclick="AppController.closeModal('invoice')">
                            <i class="fas fa-check"></i> Done
                        </button>
                    </div>
                `;
                
                elements.invoiceContent.innerHTML = invoiceHTML;
                this.openModal('invoice');
            }

            static printInvoice() {
                const invoiceContent = elements.invoiceContent.innerHTML;
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>FarmTrails Invoice</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .invoice-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
                            .invoice-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
                            .invoice-items { margin-bottom: 20px; }
                            .invoice-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
                            .invoice-total { border-top: 2px solid #4CAF50; padding-top: 10px; font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        ${invoiceContent}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            static async handleLogout() {
                const success = await CustomerAPIService.logoutUser(AppState.currentUserId);
                if (success) {
                    this.showNotification('Logged out successfully');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                } else {
                    this.showNotification('Error during logout');
                }
            }

            // Display Methods
            static displayProducts(products) {
                if (!products || products.length === 0) {
                    elements.productsContainer.innerHTML = this.getNoResultsHTML('No Products Available', 'Try adjusting your search terms or browse categories');
                    return;
                }
                elements.productsContainer.innerHTML = products.map(product => {
                    const isOutOfStock = product.stock === 0;
                    const isLowStock = product.stock > 0 && product.stock < 10;
                    const cardClass = isOutOfStock ? 'card out-of-stock' : 'card';
                    const category = CATEGORIES.find(cat => cat.id === product.category);
                    // Link to product-details.html?id=PRODUCT_ID
                    return `
                    <a href="product-details.html?id=${product.id}" class="${cardClass}" style="text-decoration:none;color:inherit;">
                        <div class="card-img">
                            <img src="${product.images?.[0] || 'https://via.placeholder.com/300x200?text=Product+Image'}" 
                                 alt="${product.name}" 
                                 onerror="this.src='https://via.placeholder.com/300x200?text=Product+Image'">
                            ${category ? `<div class="card-badge" style="background: ${category.color}">${category.name}</div>` : ''}
                        </div>
                        <div class="card-content">
                            <h3>${product.name}</h3>
                            <p>${product.description.substring(0, 100)}...</p>
                            <div class="card-price">â‚¹${product.price} / ${product.unit}</div>
                            <div class="card-meta">
                                <span><i class="fas fa-store"></i> ${product.farmer?.farm || 'Local Farm'}</span>
                                <span><i class="fas fa-box"></i> ${product.stock} in stock</span>
                            </div>
                            ${isLowStock ? `<div class="stock-low">Only ${product.stock} left in stock!</div>` : ''}
                            <div class="card-actions">
                                <button class="btn btn-outline" onclick="event.preventDefault(); AppController.viewProductDetails('${product.id}')">Details</button>
                                <button class="btn btn-primary" 
                                        onclick="event.preventDefault(); AppController.addToCart({
                                            id: '${product.id}',
                                            name: '${product.name.replace(/'/g, "\\'")}',
                                            price: ${product.price},
                                            image: '${product.images?.[0] || 'https://via.placeholder.com/300x200?text=Product+Image'}',
                                            type: 'product'
                                        })" 
                                        ${isOutOfStock ? 'disabled' : ''}>
                                    ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                                </button>
                            </div>
                        </div>
                    </a>
                    `;
                }).join('');
            }

            static displayTours(tours) {
                if (!tours || tours.length === 0) {
                    elements.toursContainer.innerHTML = this.getNoResultsHTML('No Tours Available', 'Try adjusting your search terms or check back later');
                    return;
                }
                
                elements.toursContainer.innerHTML = tours.map(tour => `
                    <div class="card" onclick="AppController.viewTourDetails('${tour.id}')">
                        <div class="card-img">
                            <img src="${tour.images?.[0] || 'https://via.placeholder.com/300x200?text=Tour+Image'}" 
                                 alt="${tour.name}"
                                 onerror="this.src='https://via.placeholder.com/300x200?text=Tour+Image'">
                            <div class="card-badge" style="background: var(--secondary)">Farm Tour</div>
                        </div>
                        <div class="card-content">
                            <h3>${tour.name}</h3>
                            <p>${tour.description.substring(0, 100)}...</p>
                            <div class="card-price">â‚¹${tour.price} / person</div>
                            <div class="card-meta">
                                <span><i class="fas fa-clock"></i> ${tour.duration}</span>
                                <span><i class="fas fa-users"></i> ${tour.capacity}</span>
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-outline" onclick="event.stopPropagation(); AppController.viewTourDetails('${tour.id}')">Details</button>
                                <button class="btn btn-primary" onclick="event.stopPropagation(); AppController.addToCart({
                                    id: '${tour.id}',
                                    name: '${tour.name.replace(/'/g, "\\'")}',
                                    price: ${tour.price},
                                    image: '${tour.images?.[0] || 'https://via.placeholder.com/300x200?text=Tour+Image'}',
                                    type: 'tour'
                                })">
                                    Book Now
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            static displayOrders(orders) {
                if (!orders || orders.length === 0) {
                    elements.noOrders.style.display = 'block';
                    return;
                }
                
                elements.noOrders.style.display = 'none';
                elements.ordersList.innerHTML = '';
                
                orders.forEach(order => {
                    const orderElement = document.createElement('div');
                    orderElement.className = 'order-item';
                    
                    let statusClass = '';
                    let statusText = '';
                    
                    switch(order.status) {
                        case 'delivered':
                            statusClass = 'status-delivered';
                            statusText = 'Delivered';
                            break;
                        case 'pending':
                            statusClass = 'status-pending';
                            statusText = 'Pending';
                            break;
                        case 'cancelled':
                            statusClass = 'status-cancelled';
                            statusText = 'Cancelled';
                            break;
                        default:
                            statusClass = 'status-pending';
                            statusText = 'Processing';
                    }
                    
                    orderElement.innerHTML = `
                        <div class="order-header">
                            <div>
                                <div class="order-id">${order.order_id}</div>
                                <div class="order-date">${new Date(order.created_at).toLocaleDateString()}</div>
                            </div>
                            <div class="order-status ${statusClass}">${statusText}</div>
                        </div>
                        ${order.items ? order.items.map(item => `
                            <div class="order-details">
                                <img src="${item.image}" alt="${item.name}" class="order-product-img">
                                <div class="order-product-info">
                                    <div class="order-product-name">${item.name}</div>
                                    <div class="order-product-price">â‚¹${item.price} x ${item.quantity}</div>
                                </div>
                            </div>
                        `).join('') : ''}
                        <div class="order-total">Total: â‚¹${order.total}</div>
                        <div style="margin-top: 10px; text-align: center;">
                            <button class="btn btn-outline" style="font-size: 0.8rem;" onclick="AppController.viewInvoice('${order.id}')">
                                View Invoice
                            </button>
                        </div>
                    `;
                    
                    elements.ordersList.appendChild(orderElement);
                });
            }

            static displayProfile(profile) {
                if (!profile) {
                    profile = this.getDefaultProfile();
                }

                const displayName = profile.username || profile.full_name || profile.name || 'Customer';
                const email = profile.email || 'guest@example.com';
                const location = profile.location || 'Not provided';
                const mobile = profile.mobile || profile.phone || null;
                const status = profile.status || 'active';
                const joined = profile.joined_date
                    || (profile.created_at ? new Date(profile.created_at).getFullYear() : null)
                    || new Date().getFullYear();
                const avatar = profile.profile_photo_url || profile.avatar_url || '';

                elements.userName.textContent = displayName;
                elements.userEmail.textContent = email;
                elements.userLocation.innerHTML = `
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${location}</span>${mobile ? ` Â· ${mobile}` : ''}${status ? ` Â· ${status}` : ''}
                `;
                elements.ordersCount.textContent = profile.orders_count || 0;
                elements.cartItemsCount.textContent = AppState.cartItems.reduce((total, item) => total + item.quantity, 0);
                elements.joinedDate.textContent = joined;

                const avatarEl = document.querySelector('.profile-avatar');
                if (avatarEl) {
                    if (avatar) {
                        avatarEl.style.background = `url('${avatar}') center/cover no-repeat`;
                        avatarEl.innerHTML = '';
                    } else {
                        avatarEl.style.background = 'var(--primary)';
                        avatarEl.innerHTML = '<i class="fas fa-user"></i>';
                    }
                }
            }

            // Utility Methods
            static showNotification(message, duration = 3000) {
                const notification = document.createElement('div');
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    right: 20px;
                    background: var(--primary);
                    color: white;
                    padding: 10px 20px;
                    border-radius: var(--radius);
                    z-index: 1000;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    font-size: 0.9rem;
                    max-width: 300px;
                    word-wrap: break-word;
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 500);
                }, duration);
            }

            static getLoadingHTML(message) {
                return `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>${message}</p>
                    </div>
                `;
            }

            static getErrorHTML(message, isModal = false) {
                return `
                    <div class="${isModal ? 'empty-state' : 'no-results'}">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>${message}</h3>
                        <p>Failed to load data. Please try again later.</p>
                    </div>
                `;
            }

            static getNoResultsHTML(title, message) {
                return `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>${title}</h3>
                        <p>${message}</p>
                    </div>
                `;
            }

            // Product Details Page Navigation
            static viewProductDetails(productId) {
                // Store the product ID in localStorage to retrieve on the details page
                localStorage.setItem('selectedProductId', productId);
                // Navigate to the product details page
                window.location.href = 'product-details.html';
            }

            static viewTourDetails(tourId) {
                // Store the tour ID in localStorage to retrieve on the details page
                localStorage.setItem('selectedTourId', tourId);
                // Navigate to the tour details page
                window.location.href = 'tour-details.html';
            }

            static viewInvoice(orderId) {
                // Find the order in the orders list
                CustomerAPIService.getOrders(AppState.currentUserId)
                    .then(orders => {
                        const order = orders.find(o => o.id === orderId);
                        if (order) {
                            this.showInvoice(order);
                        } else {
                            this.showNotification('Invoice not found');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching order:', error);
                        this.showNotification('Error loading invoice');
                    });
            }

            // Placeholder methods for future implementation
            static editProfile() {
                this.showNotification('Edit profile functionality would open here');
            }

            static viewAddresses() {
                this.showNotification('Address management would open here');
            }

            static changePassword() {
                this.showNotification('Password change functionality would open here');
            }

            static contactSupport() {
                this.showNotification('Contact support functionality would open here');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            AppController.initialize();
            
            // Auto-refresh data every 30 minutes
            setInterval(async () => {
                console.log('Auto-refreshing data...');
                await AppController.loadProducts(AppState.currentCategory);
                await AppController.loadTours();
            }, 1800000);
        });
    </script>
    <script>
        // Lightweight location detection + serviceability check
        (function(){
            const currentLocationSection = document.getElementById('currentLocationSection');
            const locationSection = document.getElementById('locationSection');
            const locationLoading = document.getElementById('locationLoading');
            const manualLocationInput = document.getElementById('manualLocationInput');
            const locationActionButtons = document.getElementById('locationActionButtons');
            const currentLocationText = document.getElementById('currentLocationText');
            const deliveryWarning = document.getElementById('deliveryWarning');
            const checkoutBtn = document.getElementById('checkoutBtn');

            function isServiceable(city, state, pincode) {
                if (!city && !pincode) return false;
                const c = (city || '').toLowerCase();
                const s = (state || '').toLowerCase();
                const p = (pincode || '').toString();

                if (c.includes('hyderabad') || c.includes('secunderabad')) return true;
                if (s.includes('telangana') && p.startsWith('50')) return true;
                if (p && p.startsWith('50')) return true;

                // Also check SERVICE_AREAS prefixes if defined
                try {
                    if (window.SERVICE_AREAS) {
                        const prefixes = Object.values(window.SERVICE_AREAS).flat();
                        for (const pref of prefixes) {
                            if (p.startsWith(pref)) return true;
                        }
                    }
                } catch(e) { }

                return false;
            }

            function setLocationUI(city, state, pincode) {
                const parts = [city, state, pincode].filter(Boolean).join(', ');
                currentLocationText.textContent = parts || 'Unknown location';
                currentLocationSection.style.display = 'block';
                locationLoading.style.display = 'none';
                manualLocationInput.style.display = 'block';
                locationActionButtons.style.display = 'flex';

                const ok = isServiceable(city, state, pincode);
                // If city exists and is not Hyderabad, show exact message requested
                const cityStr = (city || '').toLowerCase();
                if (cityStr && !cityStr.includes('hyderabad') && !cityStr.includes('secunderabad')) {
                    deliveryWarning.style.display = 'flex';
                    deliveryWarning.innerHTML = `<i class="fas fa-exclamation-triangle"></i><div><strong>Delivery Not Available</strong><p>we are currently not delivering the products outside the hyderabad</p></div>`;
                    if (checkoutBtn) checkoutBtn.disabled = true;
                    return;
                }

                if (!ok) {
                    deliveryWarning.style.display = 'flex';
                    deliveryWarning.innerHTML = `<i class="fas fa-exclamation-triangle"></i><div><strong>Delivery Not Available</strong><p>We currently deliver only within Hyderabad and surrounding areas. Please check your location.</p></div>`;
                    if (checkoutBtn) checkoutBtn.disabled = true;
                } else {
                    deliveryWarning.style.display = 'none';
                    if (checkoutBtn) checkoutBtn.disabled = false;
                }
            }

            function ipFallback() {
                fetch('https://ipapi.co/json/')
                    .then(r => r.json())
                    .then(data => {
                        const city = data.city || '';
                        const state = data.region || '';
                        const pincode = data.postal || '';
                        setLocationUI(city, state, pincode);
                    })
                    .catch(err => {
                        console.warn('IP fallback failed', err);
                        locationLoading.style.display = 'none';
                        manualLocationInput.style.display = 'block';
                        locationActionButtons.style.display = 'flex';
                    });
            }

            // Try browser geolocation first
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos){
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    // reverse geocode via ipapi (simple) or nominatim
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`)
                        .then(r => r.json())
                        .then(data => {
                            const addr = data && data.address ? data.address : {};
                            const city = addr.city || addr.town || addr.village || addr.county || '';
                            const state = addr.state || '';
                            const pincode = addr.postcode || '';
                            setLocationUI(city, state, pincode);
                        })
                        .catch(() => ipFallback());
                }, function(err){
                    console.warn('Geolocation failed, using IP fallback', err);
                    ipFallback();
                }, { enableHighAccuracy: true, timeout: 8000 });
            } else {
                ipFallback();
            }

            // Provide minimal AppController helpers that may be referenced elsewhere
            window.AppController = window.AppController || {};
            window.AppController.changeLocation = function(){
                document.getElementById('locationSection').style.display = 'block';
            };
            window.AppController.retryLocation = function(){
                locationLoading.style.display = 'block';
                manualLocationInput.style.display = 'none';
                locationActionButtons.style.display = 'none';
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(pos){
                        const lat = pos.coords.latitude;
                        const lon = pos.coords.longitude;
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`)
                            .then(r => r.json())
                            .then(data => {
                                const addr = data && data.address ? data.address : {};
                                setLocationUI(addr.city || addr.town || addr.village || '', addr.state || '', addr.postcode || '');
                            })
                            .catch(() => ipFallback());
                    }, function(){ ipFallback(); });
                } else {
                    ipFallback();
                }
            };
            window.AppController.cancelLocation = function(){
                document.getElementById('locationSection').style.display = 'none';
            };
            window.AppController.checkManualLocation = function(){
                const raw = document.getElementById('locationInput').value.trim();
                if (!raw) return alert('Please enter a location');
                // crude split: try to use first token as city
                const city = raw.split(',')[0];
                setLocationUI(city, '', '');
            };
        })();
    </script>
</body>
</html>



